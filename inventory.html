<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý tồn kho - BluePhone Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [CSS CHUNG] */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
        :root{--primary:#1a73e8;--danger:#d32f2f;--success:#34a853;--warning:#ff6d00;--bg:#f4f6f9}
        body{background:var(--bg);color:#333}
        .header{background:var(--primary);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .header .logo{font-size:24px;font-weight:bold}
        .header .user{display:flex;align-items:center;gap:10px}
        .user span{font-weight:500}
        .logout-btn{background:var(--danger);color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer}
        .logout-btn:hover{background:#b71c1c}
        .sidebar{width:260px;background:#2c3e50;color:#fff;position:fixed;top:0;left:0;height:100%;padding-top:70px;overflow-y:auto}
        .sidebar ul{list-style:none}
        .sidebar a{display:block;padding:15px 20px;color:#ecf0f1;text-decoration:none;transition:.3s;border-left:4px solid transparent}
        .sidebar a:hover{background:#34495e;border-left-color:var(--primary)}
        .sidebar i{margin-right:10px;width:18px}
        .main{margin-left:260px;padding:20px;min-height:100vh}
        .page-title{display:flex;align-items:center;gap:10px;font-size:24px;margin-bottom:20px}
        .filter-section{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}
        .filter-group{flex:1;min-width:200px}
        .filter-group label{display:block;margin-bottom:5px;font-weight:500}
        .filter-group input,.filter-group select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
        .filter-btn{background:var(--primary);color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}
        .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
        .inventory-card{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .card-title{font-size:18px;font-weight:600}
        .stock-level{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px}
        .stock-high{background:var(--success);color:#fff}
        .stock-low{background:var(--warning);color:#fff}
        .stock-critical{background:var(--danger);color:#fff}
        .stock-value{font-size:32px;font-weight:bold;text-align:center;margin:10px 0;color:var(--primary)}
        .history-list{list-style:none}
        .history-item{padding:8px 0;border-bottom:1px solid #eee;font-size:14px}
        .history-date{font-size:12px;color:#999}
        .warning-box{background:var(--danger);color:#fff;padding:15px;border-radius:8px;margin-top:20px}
        @media(max-width:992px){.sidebar{display:none}.main{margin-left:0}.filter-section{flex-direction:column}.inventory-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Blue<span style="color:#34a853">Phone</span> Admin</div>
        <div class="user">
            <i class="fas fa-user-circle" style="font-size:24px"></i>
            <span id="adminName">Admin</span>
            <button class="logout-btn" onclick="logout()">Đăng xuất</button>
        </div>
    </div>

    <nav class="sidebar">
        <ul>
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i>Tổng quan</a></li>
            <li><a href="users.html"><i class="fas fa-users"></i>Khách hàng</a></li>
            <li><a href="categories.html"><i class="fas fa-tags"></i>Loại SP</a></li>
            <li><a href="products.html"><i class="fas fa-mobile-alt"></i>Sản phẩm</a></li>
            <li><a href="imports.html"><i class="fas fa-truck-loading"></i>Nhập hàng</a></li>
            <li><a href="pricing.html"><i class="fas fa-dollar-sign"></i>Giá bán</a></li>
            <li><a href="orders.html"><i class="fas fa-shopping-cart"></i>Đơn hàng</a></li>
            <li><a href="inventory.html" class="active"><i class="fas fa-boxes"></i>Tồn kho</a></li>
        </ul>
    </nav>

    <main class="main">
        <div class="page-title">
            <i class="fas fa-boxes"></i>
            <h1>Quản lý tồn kho</h1>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label>Tìm sản phẩm</label>
                <input type="text" id="stockSearch" placeholder="Tên hoặc mã sản phẩm...">
            </div>
            <div class="filter-group">
                <label>Loại sản phẩm</label>
                <select id="stockCategory">
                    <option value="">Tất cả</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Mức tồn</label>
                <select id="stockLevel">
                    <option value="">Tất cả</option>
                    <option value="low">Thấp (< 5)</option>
                    <option value="critical">Nguy cấp (< 1)</option>
                </select>
            </div>
            <button class="filter-btn" onclick="filterStock()">Lọc</button>
        </div>

        <div id="warningBox" class="warning-box" style="display:none">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Cảnh báo:</strong> Có <span id="warningCount">0</span> sản phẩm sắp hết hàng!
        </div>

        <div class="inventory-grid" id="inventoryGrid">
            <div style="grid-column:1/-1;text-align:center;padding:40px">
                Đang tải tồn kho...
            </div>
        </div>
    </main>

    <script src="../assets/js/admin.js"></script>
    <script>
        checkAdminLogin();
        document.getElementById('adminName').textContent = JSON.parse(localStorage.getItem('currentAdmin')).username;

        // Load loại sản phẩm
        function loadCategories() {
            const categories = getData('categories');
            const select = document.getElementById('stockCategory');
            select.innerHTML = '<option value="">Tất cả</option>' + categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
        }

        // Tính tồn kho
        function calculateStock() {
            const products = getData('products');
            const imports = getData('imports');
            const orders = getData('orders');
            const stock = {};

            // Khởi tạo
            products.forEach(p => stock[p.id] = { product: p, quantity: 0 });

            // Thêm từ nhập hàng
            imports.filter(i => i.status === 'completed').forEach(i => {
                i.items.forEach(item => {
                    if (stock[item.productId]) stock[item.productId].quantity += item.quantity;
                });
            });

            // Trừ từ đơn hàng
            orders.filter(o => o.status === 'delivered').forEach(o => {
                o.items.forEach(item => {
                    if (stock[item.productId]) stock[item.productId].quantity -= item.quantity;
                });
            });

            return stock;
        }

        // Render tồn kho
        function renderInventory(stock = calculateStock()) {
            const products = getData('products');
            const categories = getData('categories');
            const grid = document.getElementById('inventoryGrid');
            const filtered = Object.values(stock).filter(s => products.some(p => p.id === s.product.id));

            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px">Chưa có dữ liệu tồn kho</div>';
                return;
            }

            grid.innerHTML = filtered.map(s => {
                const cat = categories.find(c => c.id === s.product.categoryId);
                const level = s.quantity >= 10 ? 'high' : s.quantity < 1 ? 'critical' : 'low';
                const history = getHistory(s.product.id, 7); // 7 ngày gần nhất
                return `
                    <div class="inventory-card">
                        <div class="card-header">
                            <div class="card-title">${s.product.name} (${s.product.code})</div>
                            <span class="stock-level stock-${level}">${level === 'high' ? 'Cao' : level === 'low' ? 'Thấp' : 'Nguy cấp'}</span>
                        </div>
                        <div class="stock-value">${s.quantity}</div>
                        <div style="font-size:14px;color:#666;margin-bottom:15px">${cat ? cat.name : 'N/A'}</div>
                        <div class="history-list">
                            <h5>Lịch sử 7 ngày</h5>
                            ${history.map(h => `<div class="history-item">
                                <span class="history-date">${new Date(h.date).toLocaleDateString()}</span>
                                ${h.type === 'import' ? '+' : '-'}${h.quantity}
                            </div>`).join('') || '<div>Chưa có lịch sử</div>'}
                        </div>
                    </div>
                `;
            }).join('');

            // Cảnh báo
            const lowCount = filtered.filter(s => s.quantity < 5).length;
            const warningBox = document.getElementById('warningBox');
            if (lowCount > 0) {
                document.getElementById('warningCount').textContent = lowCount;
                warningBox.style.display = 'block';
            } else {
                warningBox.style.display = 'none';
            }
        }

        // Lịch sử nhập-xuất-tồn
        function getHistory(productId, days) {
            const imports = getData('imports');
            const orders = getData('orders');
            const history = [];
            const endDate = new Date();
            const startDate = new Date(endDate - days * 24 * 60 * 60 * 1000);

            // Nhập
            imports.filter(i => new Date(i.date) >= startDate).forEach(i => {
                i.items.filter(item => item.productId === productId).forEach(item => {
                    history.push({ date: i.date, type: 'import', quantity: item.quantity });
                });
            });

            // Xuất
            orders.filter(o => new Date(o.date) >= startDate && o.status === 'delivered').forEach(o => {
                o.items.filter(item => item.productId === productId).forEach(item => {
                    history.push({ date: o.date, type: 'export', quantity: item.quantity });
                });
            });

            return history.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Lọc tồn kho
        window.filterStock = () => {
            const query = document.getElementById('stockSearch').value.toLowerCase();
            const category = document.getElementById('stockCategory').value;
            const level = document.getElementById('stockLevel').value;
            const stock = calculateStock();
            let filtered = Object.values(stock);

            if (query) filtered = filtered.filter(s => s.product.name.toLowerCase().includes(query) || s.product.code.toLowerCase().includes(query));
            if (category) filtered = filtered.filter(s => s.product.categoryId === category);
            if (level === 'low') filtered = filtered.filter(s => s.quantity < 5 && s.quantity > 0);
            if (level === 'critical') filtered = filtered.filter(s => s.quantity < 1);

            renderInventory({ ...stock, ...Object.fromEntries(filtered.map(s => [s.product.id, s])) });
        };

        // Load ban đầu
        loadCategories();
        renderInventory();
        document.getElementById('stockSearch').addEventListener('keyup', filterStock);
    </script>
</body>
</html>