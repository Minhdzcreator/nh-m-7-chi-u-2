<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đơn hàng - BluePhone Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [CSS CHUNG] */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
        :root{--primary:#1a73e8;--danger:#d32f2f;--success:#34a853;--warning:#ff6d00;--bg:#f4f6f9}
        body{background:var(--bg);color:#333}
        .header{background:var(--primary);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .header .logo{font-size:24px;font-weight:bold}
        .header .user{display:flex;align-items:center;gap:10px}
        .user span{font-weight:500}
        .logout-btn{background:var(--danger);color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer}
        .logout-btn:hover{background:#b71c1c}
        .sidebar{width:260px;background:#2c3e50;color:#fff;position:fixed;top:0;left:0;height:100%;padding-top:70px;overflow-y:auto}
        .sidebar ul{list-style:none}
        .sidebar a{display:block;padding:15px 20px;color:#ecf0f1;text-decoration:none;transition:.3s;border-left:4px solid transparent}
        .sidebar a:hover{background:#34495e;border-left-color:var(--primary)}
        .sidebar i{margin-right:10px;width:18px}
        .main{margin-left:260px;padding:20px;min-height:100vh}
        .page-title{display:flex;align-items:center;gap:10px;font-size:24px;margin-bottom:20px}
        .filter-section{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}
        .filter-group{flex:1;min-width:200px}
        .filter-group label{display:block;margin-bottom:5px;font-weight:500}
        .filter-group input,.filter-group select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
        .filter-btn{background:var(--primary);color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
        th{background:#f8f9fa;font-weight:600}
        .status-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}
        .status-new{background:var(--primary);color:#fff}
        .status-processing{background:var(--warning);color:#fff}
        .status-delivered{background:var(--success);color:#fff}
        .status-cancelled{background:var(--danger);color:#fff}
        .btn-small{padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin:0 2px}
        .btn-process{background:var(--warning);color:#fff}
        .btn-deliver{background:var(--success);color:#fff}
        .btn-cancel{background:var(--danger);color:#fff}
        .order-detail{display:none;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-top:10px}
        .detail-items ul{list-style:none}
        .detail-items li{padding:5px 0;border-bottom:1px solid #eee}
        @media(max-width:992px){.sidebar{display:none}.main{margin-left:0}.filter-section{flex-direction:column}}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Blue<span style="color:#34a853">Phone</span> Admin</div>
        <div class="user">
            <i class="fas fa-user-circle" style="font-size:24px"></i>
            <span id="adminName">Admin</span>
            <button class="logout-btn" onclick="logout()">Đăng xuất</button>
        </div>
    </div>

    <nav class="sidebar">
        <ul>
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i>Tổng quan</a></li>
            <li><a href="users.html"><i class="fas fa-users"></i>Khách hàng</a></li>
            <li><a href="categories.html"><i class="fas fa-tags"></i>Loại SP</a></li>
            <li><a href="products.html"><i class="fas fa-mobile-alt"></i>Sản phẩm</a></li>
            <li><a href="imports.html"><i class="fas fa-truck-loading"></i>Nhập hàng</a></li>
            <li><a href="pricing.html"><i class="fas fa-dollar-sign"></i>Giá bán</a></li>
            <li><a href="orders.html" class="active"><i class="fas fa-shopping-cart"></i>Đơn hàng</a></li>
            <li><a href="inventory.html"><i class="fas fa-boxes"></i>Tồn kho</a></li>
        </ul>
    </nav>

    <main class="main">
        <div class="page-title">
            <i class="fas fa-shopping-cart"></i>
            <h1>Quản lý đơn hàng</h1>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label>Từ ngày</label>
                <input type="date" id="fromDate">
            </div>
            <div class="filter-group">
                <label>Đến ngày</label>
                <input type="date" id="toDate">
            </div>
            <div class="filter-group">
                <label>Trạng thái</label>
                <select id="statusFilter">
                    <option value="">Tất cả</option>
                    <option value="new">Mới đặt</option>
                    <option value="processing">Đang xử lý</option>
                    <option value="delivered">Đã giao</option>
                    <option value="cancelled">Hủy</option>
                </select>
            </div>
            <button class="filter-btn" onclick="filterOrders()">Lọc</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Khách hàng</th>
                    <th>Ngày đặt</th>
                    <th>Trạng thái</th>
                    <th>Tổng tiền</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="orderList">
                <tr><td colspan="6">Đang tải...</td></tr>
            </tbody>
        </table>
    </main>

    <script src="../assets/js/admin.js"></script>
    <script>
        checkAdminLogin();
        document.getElementById('adminName').textContent = JSON.parse(localStorage.getItem('currentAdmin')).username;

        // Render danh sách đơn hàng
        function renderOrders(orders = getData('orders')) {
            const tbody = document.getElementById('orderList');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px">Chưa có đơn hàng nào</td></tr>';
                return;
            }
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.id}</td>
                    <td>${order.customerName} (${order.customerEmail})</td>
                    <td>${new Date(order.date).toLocaleDateString('vi-VN')}</td>
                    <td><span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span></td>
                    <td>${order.total.toLocaleString()}₫</td>
                    <td>
                        <button class="btn-small" onclick="viewOrderDetail('${order.id}')">Chi tiết</button>
                        ${order.status === 'new' ? `<button class="btn-small btn-process" onclick="updateOrderStatus('${order.id}', 'processing')">Xử lý</button>` : ''}
                        ${order.status === 'processing' ? `<button class="btn-small btn-deliver" onclick="updateOrderStatus('${order.id}', 'delivered')">Giao hàng</button>` : ''}
                        ${order.status !== 'cancelled' ? `<button class="btn-small btn-cancel" onclick="updateOrderStatus('${order.id}', 'cancelled')">Hủy</button>` : ''}
                    </td>
                </tr>
                <tr id="detail-${order.id}" class="order-detail">
                    <td colspan="6">
                        <h4>Chi tiết đơn hàng #${order.id}</h4>
                        <div class="detail-items">
                            <ul>
                                ${order.items.map(item => `<li>${item.name} x${item.quantity} - ${item.price.toLocaleString()}₫ = ${(item.quantity * item.price).toLocaleString()}₫</li>`).join('')}
                            </ul>
                            <p><strong>Tổng: ${order.total.toLocaleString()}₫</strong></p>
                            <p>Ghi chú: ${order.note || 'Không có'}</p>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Lọc đơn hàng
        window.filterOrders = () => {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const status = document.getElementById('statusFilter').value;
            let orders = getData('orders');

            if (fromDate) orders = orders.filter(o => new Date(o.date) >= new Date(fromDate));
            if (toDate) orders = orders.filter(o => new Date(o.date) <= new Date(toDate));
            if (status) orders = orders.filter(o => o.status === status);

            renderOrders(orders);
        };

        // Xem chi tiết
        window.viewOrderDetail = (id) => {
            const detail = document.getElementById(`detail-${id}`);
            detail.style.display = detail.style.display === 'none' ? 'table-row' : 'none';
        };

        // Cập nhật trạng thái
        window.updateOrderStatus = (id, status) => {
            if (confirm(`Cập nhật trạng thái thành ${status}?`)) {
                let orders = getData('orders');
                const order = orders.find(o => o.id === id);
                if (order) {
                    order.status = status;
                    order.updatedAt = new Date().toISOString();
                    saveData('orders', orders);
                    if (status === 'delivered') updateStock(order.items, 'subtract');
                    alert('Cập nhật thành công!');
                    renderOrders();
                }
            }
        };

        // Load ban đầu
        renderOrders();
        document.getElementById('fromDate').valueAsDate = new Date(new Date().setDate(new Date().getDate() - 7));
        document.getElementById('toDate').valueAsDate = new Date();
    </script>
</body>
</html>